<!-- https://www.kaggle.com/datasets/dataanalyst001/population-of-all-us-cities-2024 -->
 
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="src/style.css">
        <script src='https://d3js.org/d3.v5.min.js'></script>
    </head>
 
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <body onload='init()'>
      <div class="title-container" style="margin-bottom: -50px;">
          <h1 class="title">Population Of All popular US Cities</h1>
          <h2 class="subtitle">Explore demographic trends across different cities</h2>
      </div>

      <div class="svg-popup-container">
        <svg class="clickShowText" width="0" height="0"></svg>
      </div>

      <div class="introduction-text" style="display: block; margin: 20px 2%; padding: 5px 2%; ">
        <p class="title" style="padding-bottom: 10px; font-weight: 600; font-family: 'Raboto', sans-serif; text-align: left;">
          This visualization project uses the 'Population of All US Cities 2024' dataset, which gives information about the population of 300 popular U.S. cities in the years 2020 and 2024. On this website, the readers can find three graphs, which are "Area vs Population in 2020" (default showing), "Area vs Population in 2024", and "City Population Trends" (annual change of population in each city between 2020 and 2024). These graphs are overviews of population changes and population information in each city. Hopefully, this website can be useful for selecting work locations or for academic purposes or other usages.
        </p>
        <hr style="height : 4px; background-color:rgb(161, 160, 160); margin:5px -10px;">
      </div>
      
      <!-- seperate the three SVGs into three scenes -->
      <div class="scene-button-container">
        <div class="scene-buttons">
          <button onclick="renderSceneOne()">Area vs Population 2020 (default)</button>
          <button onclick="renderSceneTwo()">Area vs Population 2024</button>
          <button onclick="renderSceneThree()">City Population Trends</button>
        </div>
      </div>

      <div class="scene-one-text" style="display: block; margin: 10px 10%; padding: 5px 2%; border : 1px dotted grey; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);">
        <p class="title" style="padding-bottom: 10px; font-weight: 500; font-family: 'Raboto', sans-serif;">
          This graph represents the relationship between the area and population of popular cities in the U.S. in the year 2020. The x-axis represents the area of each city and the y-axis represents the population. The size of each circle represents the density of the city. The color of the circle represents the region of all the states.
        </p>
        <p style="color: rgb(141, 141, 141);">Readers can filter the data by different census regions, such as Western, Midwestern, Southern, and Eastern States, as well as more specific regions like the Pacific States, etc. Users can also hover over regions to see different regions (trigger this when hovering/un-hovering the legend of the region).</p>
      </div>
      
      <div class="scene-two-text" style="display: none; margin: 10px 10%; padding: 5px 2%; border : 1px dotted grey; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);">
        <p class="title" style="padding-bottom: 10px; font-weight: 500; font-family: 'Raboto', sans-serif;">This graph represents the relationship between the area and population of popular cities in the U.S. in the year 2024. The x-axis represents the area of each city and the y-axis represents the population. The size of each circle represents the density of the city. The color of the circle represents the region of all the states.</p>
        <p style="color: rgb(141, 141, 141);">Readers can filter the data by different census regions, such as Western, Midwestern, Southern, and Eastern States, as well as more specific regions like the Pacific States, etc. Users can also hover over regions to see different regions (trigger this when hovering/un-hovering the legend of the region).</p>
      </div>
      
      <div class="scene-three-text" style="display: none; margin: 10px 10%; padding: 5px 2%; border : 1px dotted grey; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);">
        <p class="title" style="padding-bottom: 10px; font-weight: 500; font-family: 'Raboto', sans-serif;">
          This graph shows how the population in each city increases or decreases. Green represents the increasing and red represents the decreasing.
        </p>
      </div>
      
    
      <div class="clear_button">
        <button onclick="clearData()">Clear</button>
      </div>
      <div class="flex-container">
        <div class="button-container">
            <button onclick="logRegion('Western States')">Western States</button>
            <div class="nested-buttons">
                <button onclick="logRegion('Pacific States')">Pacific States</button>
                <button onclick="logRegion('Mountain States')">Mountain States</button>
            </div>
        </div>
        <div class="button-container">
            <button onclick="logRegion('Midwestern States')">Midwestern States</button>
            <div class="nested-buttons">
                <button onclick="logRegion('East North Central')">East North Central</button>
                <button onclick="logRegion('West North Central')">West North Central</button>
            </div>
        </div>
        <div class="button-container">
            <button onclick="logRegion('Eastern States')">Eastern States</button>
            <div class="nested-buttons">
                <button onclick="logRegion('Northeast')">Northeast</button>
                <button onclick="logRegion('South Atlantic')">South Atlantic</button>
            </div>
        </div>
        <div class="button-container">
          <button onclick="logRegion('Southern States')">Southern States</button>
          <div class="nested-buttons">
              <button onclick="logRegion('East South Central')">East South Central</button>
              <button onclick="logRegion('West South Central')">West South Central</button>
              <button onclick="logRegion('South Atlantic')">South Atlantic</button>
          </div>
        </div>
      </div>

      <div class="svg-container0">
        <!-- SVG inside a div that controls the size -->
        <svg class="svg0" viewBox="0 0 960 500"></svg>
        <svg class="svg0_region"></svg>
      </div>

      <div class="svg-container">
          <!-- SVG inside a div that controls the size -->
          <svg class="svg1" viewBox="0 0 960 500"></svg>
          <svg class="svg1_region"></svg>
      </div>
 
      <!-- delete the reset-button because it is not useful by resetting to dataset order -->
      <!-- <div class="reset_button">
        <button onclick="resetData()">Reset</button>
      </div> -->
      <div id="sortButton" class="flex-container">
        <div class="button-container">
          <p>Sort by AnnualChange</p>
          <div class="nested-buttons">
              <button onclick="sortingChange('SortByChangeUp','')">Sort by AnnualChange ↑</button>
              <button onclick="sortingChange('SortByChangeDown','')">Sort by AnnualChange ↓</button>
          </div>
        </div>
        <div class="button-container">
          <p>Sort Alphabetically (default)</p>
          <div class="nested-buttons">
              <button onclick="sortingChange('SortByAlphabeticUp','')">Sort Alphabetically a → z</button>
              <button onclick="sortingChange('SortByAlphabeticDown','')">Sort Alphabetically z → a</button>
          </div>
        </div>
      </div>
     
      <div class="svg-container2">
          <!-- SVG inside a div that controls the size -->
          <svg class="svg2" viewBox="0 0 960 4500"></svg>
          <svg class="svg2_region"></svg>
      </div>
 
 
      <!-- tooltip -->
       <div id="tooltip0" class="tooltip0"></div>
       <div id="tooltip" class="tooltip"></div>
       <div id="tooltip2" class="tooltip2"></div>

       <div class="citation">
        <p>Author: </p>
        <h4>Puyu Yang</h4>
        <br>
        <p>Reference: </p>
        <a href="https://www.kaggle.com/datasets/dataanalyst001/population-of-all-us-cities-2024?resource=download">Population of all US Cities 2024 DataSet</a>
       </div>

<script>
 
 
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                              Define state groups                                         //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    const pacificStates = ["California", "Oregon", "Washington", "Alaska", "Hawaii"];
    const mountainStates = ["Arizona", "Nevada", "New Mexico", "Utah", "Colorado", "Idaho", "Montana", "Wyoming"];
    const westernStates = [...pacificStates, ...mountainStates];
 
    const eastNorthCentral = ["Ohio", "Indiana", "Michigan", "Illinois", "Wisconsin"];
    const westNorthCentral = ["Missouri", "North Dakota", "South Dakota", "Nebraska", "Kansas", "Minnesota", "Iowa"];
    const midwesternStates = [...eastNorthCentral, ...westNorthCentral];
 
    const southAtlantic = ["Delaware", "Maryland", "Virginia", "West Virginia", "North Carolina", "South Carolina", "Georgia", "Florida", "District of Columbia"];
    const eastSouthCentral = ["Kentucky", "Tennessee", "Alabama", "Mississippi"];
    const westSouthCentral = ["Arkansas", "Louisiana", "Oklahoma", "Texas"];
    const southernStates = [...southAtlantic, ...eastSouthCentral, ...westSouthCentral];
 
    const northeast = ["Maine", "New Hampshire", "Vermont", "Massachusetts", "Rhode Island", "Connecticut", "New York", "New Jersey", "Pennsylvania"];
    const easternStates = [...northeast, ...southAtlantic];
 
    const usTerritories = ["Puerto Rico", "Guam", "U.S. Virgin Islands", "Northern Mariana Islands", "American Samoa"];
 
    const wholeUS = [...westernStates, ...midwesternStates, ...southernStates, ...easternStates, ...usTerritories];
 
    let original_data = [];

    let regions_specific= wholeUS;

    // annotation
    let annotations_svg0 = [];
    let annotations_svg1 = [];
    let annotations_svg2 = [];

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                        annotation function                                               //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function wrapText(text, string, currentX, currentY, direction) {
        const words = string.split(/\n/);
        // console.log(words);
        let lineNumber = 0;
        const lineHeight = 1.2; // ems
        // const y = text.attr("y");
        const dy = parseFloat(text.attr("dy") || 0);

        let xOffset = 10;
        if(direction == 1) xOffset += 60;

        for (let i = 0; i < words.length; i++) {
          text.append("tspan")
              .attr("x", currentX - xOffset)
              .attr("y", currentY)
              .attr("dy", ++lineNumber * lineHeight + dy + "em")
              .text(words[i]);
        }
    }

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                        Define tooltip function                                           //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function showTooltip(d, tooltipHere) {
      tooltipHere
        .transition()
        .duration(200)
      tooltipHere.style("opacity", 0.8)
          .html(d.USCity + "\n" + d.USState + "\n" + d.Density)
          .style("left", (d3.event.pageX + 10) + "px")
          .style("top", (d3.event.pageY + 10) + "px")
    }

    function moveTooltip(d, tooltipHere) {
      tooltipHere
          .style("left", (d3.event.pageX + 10) + "px")
          .style("top", (d3.event.pageY + 10) + "px")
    }

    function hideTooltip(d, tooltipHere) {
      tooltipHere
          .transition()
          .duration(200)
          .style("opacity", 0)
    }

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                         Add highlight function                                           //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function highlight(d, svgNumber) {
        d3.selectAll(".bubbles").style("opacity", 0.05);
        let stateArray;
        switch(d.region) {
            case "Western States":
                stateArray = westernStates;
                break;
            case "Pacific States":
                stateArray = pacificStates;
                break;
            case "Mountain States":
                stateArray = mountainStates;
                break;
            case "Midwestern States":
                stateArray = midwesternStates;
                break;
            case "East North Central":
                stateArray = eastNorthCentral;
                break;
            case "West North Central":
                stateArray = westNorthCentral;
                break;
            case "Eastern States":
                stateArray = easternStates;
                break;
            case "Northeast":
                stateArray = northeast;
                break;
            case "South Atlantic":
                stateArray = southAtlantic;
                break;
            case "Southern States":
                stateArray = southernStates;
                break;
            case "East South Central":
                stateArray = eastSouthCentral;
                break;
            case "West South Central":
                stateArray = westSouthCentral;
                break;
            default: 
                return; 
        }
    
        // Highlight the states based on the selected region
        stateArray.forEach(state => {
            d3.selectAll("." + state.replace(/\s+/g, '-')).style("opacity", 1);
        });
    }
  

    function noHighlight(d, svgNumber) {
      d3.selectAll(".bubbles").style("opacity", 1);
    }

    // ----------------------------------------------------------------------------------------------------------------------------------------------------


    async function init() {
      original_data = await d3.csv('https://raw.githubusercontent.com/pyangyu/NarrativeVisualization/main/data/PopulationOfAllUSCities2024.csv');
      let data = original_data;

      let maxRow = data.reduce((max, row) => parseFloat(row.Density) > parseFloat(max.Density) ? row : max, data[0]);
      let minRow = data.reduce((min, row) => parseFloat(row.Density) < parseFloat(min.Density) ? row : min, data[0]);

      var data_region = [
          { region: "Western States", color: "#2222D2" },
          { region: "Pacific States", color: "#FF8C00" },
          { region: "Mountain States", color: "#ADFF2F" },
          { region: "Midwestern States", color: "#1EB50D" },
          { region: "East North Central", color: "#F08080" },
          { region: "West North Central", color: "#90EE90" },
          { region: "Eastern States", color: "#CB1522" },
          { region: "Northeast", color: "#86F4FF" },
          { region: "South Atlantic", color: "#20B2AA" },
          { region: "Southern States", color: "#FFF347" },
          { region: "East South Central", color: "#B496FF" },
          { region: "West South Central", color: "#23E9A7" },
          { region: "South Atlantic", color: "#20B2AA" },
      ];

      renderSceneOne();

      //////////////////////////////////////////////////////////////////////////////////////////////////////////////
      //                                                                                                          //
      //                                              Define svg0 graph                                           //
      //                                                                                                          //
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // region

      var svg_r0 = d3.select("svg.svg0_region");

      // Create Legend
      var legend0 = svg_r0.append("g")
                      .attr("class", "legend")
                      .attr("transform", "translate(50, 50)");
 
      legend0.selectAll("rect")
            .data(data_region)
            .enter().append("rect")
            .attr("x", function(d,i) {if(i == 12 || i % 3 == 2 || i % 3 == 1) return 25; return 0;})
            .attr("y", function(d, i) { return i * 24; })
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d) { return d.color; })
            .on("mouseover", d => highlight(d, "zero"))
            .on("mouseout", d => noHighlight(d, "zero"));
 
      legend0.selectAll("text")
            .data(data_region)
            .enter().append("text")
            .attr("x", function(d,i) {if(i == 12 || i % 3 == 2 || i % 3 == 1) return 50; return 25;})
            .attr("y", function(d, i) { return i * 24 + 14; })
            .text(function(d) { return d.region; })
            .on("mouseover", d => highlight(d, "zero"))
            .on("mouseout", d => noHighlight(d, "zero"));
 
      legend0.append("text")
            .attr("x", 0)
            .attr("y", -10)
            .attr("font-weight", "bold")
            .text("Region");       
 
 
      var svg0 = d3.select("svg.svg0");
 
      var x0 = d3.scaleLog()
                .range([0, 860])
                .domain([6, 1500]);
 
      var y0 = d3.scaleLog()
                .range([400, 0])
                .domain([90000, 7000000]);

      var gPoints0 = svg0.append("g")
                       .attr("transform", "translate(60, 50)");
 
      var tooltip0 = d3.select("#tooltip0")
                       .style("opacity",0)
                       .style("background-color", "black")
                       .style("border-radius", "5px")
                       .style("padding", "10px")
                       .style("color", "white");
 
      gPoints0.selectAll(".circle")
        .data(data)
        .enter().append("circle")
        .attr("class", function(d) {
            let className = "bubbles " + (d.USState ? d.USState.replace(/\s+/g, '-') : "undefined-state");
            // console.log(className);  // add hyphon
            return className;
        })
        .attr("cx", function(d) { return x0(d.Area); })
        .attr("cy", function(d) { return y0(d.Population2020); })
        .attr("r", function(d) { return 2; })
        .attr("fill", function(d) {return checkCity(d.USState);})
        .on("click", d => circleClick(d))
        .on('mouseover', d => showTooltip(d, tooltip0))
        .on('mousemove', d => moveTooltip(d, tooltip0))
        .on('mouseout', d => hideTooltip(d, tooltip0))
        .transition().duration(3000).delay(1000)
        .attr("r", function(d) { return Math.pow(d.Density, 1/4.2); });
 
      var gYAxes0 = svg0.append("g")
                      .attr("transform", "translate(" + 60 + "," + 50 + ")")
                      .call(d3.axisLeft(y0)
                        .tickFormat(d3.format(".0s"))); // Format ticks with SI prefix, no decimal

      var gXAxes0 = svg0.append("g")
                      .attr("transform", "translate(" + 60 + "," + 450 + ")")
                      .call(d3.axisBottom(x0)
                        .tickFormat(d3.format(".0s")));
                      
      svg0.append("g").append("text")
      .attr("class", "axis-label")
      .attr("text-anchor", "end")
      .attr("x", 520)
      .attr("y", 490)
      .text("Area");

      svg0.append("g").append("text")
      .attr("class", "axis-label")
      .attr("text-anchor", "end")
      .attr("transform", "rotate(-90)")
      .attr("x", -220)
      .attr("y", 15)
      .text("Population");

      let newAnnotation = {
        text: "City with highest density:\n" + printAnnotation(maxRow),
        x: x0(maxRow.Area),
        y: y0(maxRow.Population2020),
        dx: 40,
        dy: -20,
        direction: 'upperRight'
      };

      annotations_svg0.push(newAnnotation);

      newAnnotation = {
        text: "City with lowest density:\n" + printAnnotation(minRow),
        x: x0(minRow.Area),
        y: y0(minRow.Population2020),
        dx: -40,
        dy: -20,
        direction: 'upperLeft'
      }

      annotations_svg0.push(newAnnotation);

      annotations_svg0.forEach(anno => {
          const g = svg0.append("g")
                      .attr("class", "annotation")
                      .attr("transform", "translate(60, 50)");

          let direction = 0;
          if(anno.direction == 'upperLeft') direction = 1;
          if(anno.direction == 'lowerRight') direction = 2;
          if(anno.direction == 'lowerLeft') direction = 3;

          // Draw the line
          g.append("line")
          .attr("x1", anno.x)
          .attr("y1", anno.y)
          .attr("x2", anno.x + anno.dx / 2)
          .attr("y2", anno.y + anno.dy / 2)
          .attr("stroke", "#161847")
          .attr("stroke-width", 1.2);

          // Draw the line
          g.append("line")
          .attr("x1", anno.x + anno.dx / 2)
          .attr("y1", anno.y + anno.dy / 2)
          .attr("x2", anno.x + anno.dx + anno.dx / 2)
          .attr("y2", anno.y + anno.dy / 2)
          .attr("stroke", "#161847")
          .attr("stroke-width", 1.2);

          // Add text
          const text = g.append("text")
              .attr("class", "annotation-text")
              .attr("x", function() {
                if(direction == 1)
                  return anno.x + anno.dx - 30; 
                return anno.x + anno.dx;
              })
              .attr("y", anno.y + anno.dy)
              .attr("fill", "#495052")
              .attr("font-size", "0.5em")
              .attr("font-family", "Arial")
              .attr("text-anchor", "start");

          // Apply text wrapping
          wrapText(text, anno.text, anno.x + anno.dx + anno.dx / 2, anno.y + anno.dy / 2, direction);
      });

 
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////
      //                                                                                                          //
      //                                              Define svg1 graph                                           //
      //                                                                                                          //
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // region
 
      var svg_r = d3.select("svg.svg1_region");
 
      // Create Legend
      var legend = svg_r.append("g")
                      .attr("class", "legend")
                      .attr("transform", "translate(50, 50)");
 
      legend.selectAll("rect")
            .data(data_region)
            .enter().append("rect")
            .attr("x", function(d,i) {if(i == 12 || i % 3 == 2 || i % 3 == 1) return 25; return 0;})
            .attr("y", function(d, i) { return i * 24; })
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d) { return d.color; })
            .on("mouseover", d => highlight(d, "one"))
            .on("mouseout", d => noHighlight(d, "one"));
 
      legend.selectAll("text")
            .data(data_region)
            .enter().append("text")
            .attr("x", function(d,i) {if(i == 12 || i % 3 == 2 || i % 3 == 1) return 50; return 25;})
            .attr("y", function(d, i) { return i * 24 + 14; })
            .text(function(d) { return d.region; })
            .on("mouseover", d => highlight(d, "one"))
            .on("mouseout", d => noHighlight(d, "one"))
 
      legend.append("text")
            .attr("x", 0)
            .attr("y", -10)
            .attr("font-weight", "bold")
            .text("Region");       
 
 
      var svg = d3.select("svg.svg1");
 
      var x = d3.scaleLog()
                .range([0, 860])
                .domain([6, 1500]);
 
      var y = d3.scaleLog()
                .range([400, 0])
                .domain([90000, 7000000]);
      var gPoints = svg.append("g")
                       .attr("transform", "translate(60, 50)");
 
      var tooltip = d3.select("#tooltip")
                       .style("opacity",0)
                       .style("background-color", "black")
                       .style("border-radius", "5px")
                       .style("padding", "10px")
                       .style("color", "white");;
 
      gPoints.selectAll(".circle")
        .data(data)
        .enter().append("circle")
        .attr("class", function(d) {
            let className = "bubbles " + (d.USState ? d.USState.replace(/\s+/g, '-') : "undefined-state");
            // console.log(className);  // add hyphon
            return className;
        })
        .attr("cx", function(d) { return x(d.Area); })
        .attr("cy", function(d) { return y(d.Population2024); })
        .attr("r", function(d) { return 2; })
        .attr("fill", function(d) {return checkCity(d.USState);})
        .on("click", d => circleClick(d))
        .on('mouseover', d => showTooltip(d, tooltip))
        .on('mousemove', d => moveTooltip(d, tooltip))
        .on('mouseout', d => hideTooltip(d, tooltip))
        .transition().duration(3000).delay(1000)
        .attr("r", function(d) { return Math.pow(d.Density, 1/4.2); });
 
        var gYAxes = svg.append("g")
                       .attr("transform", "translate(" + 60 + "," + 50 + ")")
                       .call(d3.axisLeft(y)
                          .tickFormat(d3.format(".0s"))); // Format ticks with SI prefix, no decimal
 
        var gXAxes = svg.append("g")
                       .attr("transform", "translate(" + 60 + "," + 450 + ")")
                       .call(d3.axisBottom(x)
                          .tickFormat(d3.format(".0s")));
 
 
        svg.append("g").append("text")
            .attr("class", "axis-label")
            .attr("text-anchor", "end")
            .attr("x", 520)
            .attr("y", 490)
            .text("Area");
      
        svg.append("g").append("text")
            .attr("class", "axis-label")
            .attr("text-anchor", "end")
            .attr("transform", "rotate(-90)")
            .attr("x", -220)
            .attr("y", 15)
            .text("Population");

        newAnnotation = {
          text: "City with highest density:\n" + printAnnotation(maxRow),
          x: x(maxRow.Area),
          y: y(maxRow.Population2024),
          dx: 40,
          dy: -20,
          direction: 'upperRight'
        };
    
        annotations_svg1.push(newAnnotation);
    
        newAnnotation = {
          text: "City with lowest density:\n" + printAnnotation(minRow),
          x: x(minRow.Area),
          y: y(minRow.Population2024),
          dx: -40,
          dy: -20,
          direction: 'upperLeft'
        }
    
        annotations_svg1.push(newAnnotation);
    
        annotations_svg1.forEach(anno => {
            const g = svg.append("g")
                        .attr("class", "annotation")
                        .attr("transform", "translate(60, 50)");
    
            let direction = 0;
            if(anno.direction == 'upperLeft') direction = 1;
            if(anno.direction == 'lowerRight') direction = 2;
            if(anno.direction == 'lowerLeft') direction = 3;
        
            // Draw the line
            g.append("line")
            .attr("x1", anno.x)
            .attr("y1", anno.y)
            .attr("x2", anno.x + anno.dx / 2)
            .attr("y2", anno.y + anno.dy / 2)
            .attr("stroke", "#161847")
            .attr("stroke-width", 1.2);
    
            // Draw the line
            g.append("line")
            .attr("x1", anno.x + anno.dx / 2)
            .attr("y1", anno.y + anno.dy / 2)
            .attr("x2", anno.x + anno.dx + anno.dx / 2)
            .attr("y2", anno.y + anno.dy / 2)
            .attr("stroke", "#161847")
            .attr("stroke-width", 1.2);
    
            // Add text
            const text = g.append("text")
                .attr("x", function() {
                  if(direction == 1)
                    return anno.x + anno.dx - 30; 
                  return anno.x + anno.dx;
                })
                .attr("y", anno.y + anno.dy)
                .attr("fill", "#495052")
                .attr("font-size", "0.5em")
                .attr("font-family", "Arial")
                .attr("text-anchor", "start");
    
            // Apply text wrapping
            wrapText(text, anno.text, anno.x + anno.dx + anno.dx / 2, anno.y + anno.dy / 2, direction);
        });
        
 
 
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////
      //                                                                                                          //
      //                                              Define svg2 graph                                           //
      //                                                                                                          //
      //////////////////////////////////////////////////////////////////////////////////////////////////////////////
 
      // region
      var svg_r2 = d3.select("svg.svg2_region");
      var data_region2 = [
          { region: "Increase", color: "#028017" },
          { region: "Decrease", color: "#A51505" }
      ];
 
      // Create Legend
      var legend2 = svg_r2.append("g")
                      .attr("class", "legend")
                      .attr("transform", "translate(50, 50)");
 
      legend2.selectAll("rect")
            .data(data_region2)
            .enter().append("rect")
            .attr("x", 0)
            .attr("y", function(d, i) { return i * 24; })
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d) { return d.color; });
 
      legend2.selectAll("text")
            .data(data_region2)
            .enter().append("text")
            .attr("x", 25)
            .attr("y", function(d, i) { return i * 24 + 14; })
            .text(function(d) { return d.region; });
 
      legend2.append("text")
            .attr("x", 0)
            .attr("y", -10)
            .attr("font-weight", "bold")
            .text("Region");  

      // sort the data alphabetically
      data = JSON.parse(JSON.stringify(original_data));
      data.sort(function(a,b) {
        return d3.descending(a.USCity, b.USCity);
      });
                       
      var svg2 = d3.select("svg.svg2");
 
      var x2_positive = d3.scaleLinear()
                .range([0, 430])
                .domain([0, 0.06]);
 
      var x2 = d3.scaleLinear()
                .range([0, 860])
                .domain([-0.06, 0.06]);
 
      var y2 = d3.scaleBand()
                .range([4400, 0])
                .domain(data.map(function(d) {return d.USCity + ", " + d.USState;}))
                .padding(0.1);
 
      var gPoints2 = svg2.append("g")
                        .attr("transform", "translate(50, 50)");
 
      var tooltip2 = d3.select("#tooltip2")
                        .style("opacity",0)
                        .style("background-color", "black")
                        .style("border-radius", "5px")
                        .style("padding", "10px")
                        .style("color", "white");
 
      gPoints2.selectAll(".rect")
          .data(data)
          .enter().append("rect")
          .attr("x", function(d) { if(parseFloat(d.AnnualChange) < 0) return x2(0) - x2_positive(parseFloat(-d.AnnualChange)); return x2(0);})
          .attr("y", function(d) { return y2(d.USCity + ", " + d.USState); })
          .attr("width", function(d) { return 0; })
          .on("click", d => rectClick(d))
          .on('mouseover', d => showTooltip(d, tooltip2))
          .on('mousemove', d => moveTooltip(d, tooltip2))
          .on('mouseout', d => hideTooltip(d, tooltip2))
          .transition().duration(3000).delay(1000)
          .attr("width", function(d) { if(parseFloat(d.AnnualChange) < 0) return x2_positive(parseFloat(-d.AnnualChange)); return x2_positive(parseFloat(d.AnnualChange)); })
          .attr("height", y2.bandwidth())
          .attr("r", function(d) { return 10; })
          .attr("fill", function(d) {if(d.AnnualChange < 0) return "#A51505"; return "#028017";});
     
      var gYAxes2 = svg2.append("g")
                      .attr("class", "gY2")
                      .attr("transform", "translate(480, 50)")
                      .call(d3.axisLeft(y2).tickPadding(10)
                                        .tickSize(0));
 
      gYAxes2.selectAll(".tick text")
          .attr("class", "gY2-text")
          .attr("x", -450)
          .style("text-anchor", "start");
 
      var gXAxes2 = svg2.append("g")
          .attr("transform", "translate(50, 42)")
          .call(d3.axisBottom(x2)
              .tickFormat(d3.format(".0s"))
              .tickSizeInner(8)
              .tickSizeOuter(0));
 
      gXAxes2.selectAll(".tick text")
          .attr("y", -10)
          .style("text-anchor", "middle");
 
    }
 

    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                              Define update function                                      //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function updateVisualization0(filteredData, nestRegion) {
      var svg0 = d3.select("svg.svg0");

      // remove the annotation
      svg0.selectAll(".annotation").remove();
      
      svg0.selectAll("circle").remove();

      var x = d3.scaleLog()
              .range([0, 860])
              .domain([6, 1500]);

      var y = d3.scaleLog()
                .range([400, 0])
                .domain([90000, 7000000]);
                
      var gPoints = svg0.append("g")
                      .attr("transform", "translate(60, 50)");

      var tooltip = d3.select("#tooltip0");

      gPoints.selectAll(".circle")
        .data(filteredData)
        .enter().append("circle")
        .attr("class", function(d) {
            let className = "bubbles " + (d.USState ? d.USState.replace(/\s+/g, '-') : "undefined-state");
            // console.log(className);  // add hyphon
            return className;
        })
        .attr("cx", function(d) { return x(d.Area); })
        .attr("cy", function(d) { return y(d.Population2020); })
        .attr("r", function(d) { return 2; })
        .attr("fill", function(d) {
          if(nestRegion == "Pacific States") return "#FF8C00";
          if(nestRegion == "Mountain States") return "#ADFF2F";
          if(nestRegion == "East North Central") return "#F08080";
          if(nestRegion == "West North Central") return "#90EE90";
          if(nestRegion == "Northeast") return "#86F4FF";
          if(nestRegion == "South Atlantic") return "#20B2AA";
          if(nestRegion == "East South Central") return "#B496FF";
          if(nestRegion == "West South Central") return "#23E9A7";
          return checkCity(d.USState);
        })
        .on("click", d => circleClick(d))
        .on('mouseover', function(d,i) {
          tooltip.style("opacity", 0.8)
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY) + "px")
          .html(d.USCity + '\n' + d.USState + '\n' + d.Density)
        })
        .on('mouseout', function() {
          tooltip.style("opacity", 0)
        })
        .transition().duration(3000).delay(1000)
        .attr("r", function(d) { if(nestRegion == "whole") return Math.pow(d.Density, 1/4.2); return Math.pow(d.Density, 1/3.7); });

        // find new max and min
        let maxRow = filteredData.reduce((max, row) => parseFloat(row.Density) > parseFloat(max.Density) ? row : max, filteredData[0]);
        let minRow = filteredData.reduce((min, row) => parseFloat(row.Density) < parseFloat(min.Density) ? row : min, filteredData[0]);

        let shift = 0;
        let offY = 0;
        if(nestRegion == "East South Central" || nestRegion == "West South Central") shift = 1;
        if(nestRegion == "Mountain States") offY = -40;
        // use filter data to do the annotation
        let newAnnotation = {
          text: "City with highest density:\n" + printAnnotation(maxRow),
          x: x(maxRow.Area),
          y: y(maxRow.Population2020),
          dx: shift == 0 ? 40 : -40,
          dy: -20 + offY,
          direction: shift == 0 ? 'upperRight' : 'upperLeft'
        };

        annotations_svg0 = [];
  
        annotations_svg0.push(newAnnotation);
  
        newAnnotation = {
          text: "City with lowest density:\n" + printAnnotation(minRow),
          x: x(minRow.Area),
          y: y(minRow.Population2020),
          dx: shift == 0 ? -40 : 40,
          dy: -20 + offY,
          direction: shift == 0 ? 'upperLeft' : 'upperRight'
        }
  
        annotations_svg0.push(newAnnotation);
  
        annotations_svg0.forEach(anno => {
            const g = svg0.append("g")
                        .attr("class", "annotation")
                        .attr("transform", "translate(60, 50)");
  
            let direction = 0;
            if(anno.direction == 'upperLeft') direction = 1;
            if(anno.direction == 'lowerRight') direction = 2;
            if(anno.direction == 'lowerLeft') direction = 3;
        
            // Draw the line
            g.append("line")
            .attr("x1", anno.x)
            .attr("y1", anno.y)
            .attr("x2", anno.x + anno.dx / 2)
            .attr("y2", anno.y + anno.dy / 2)
            .attr("stroke", "#161847")
            .attr("stroke-width", 1.2);
  
            // Draw the line
            g.append("line")
            .attr("x1", anno.x + anno.dx / 2)
            .attr("y1", anno.y + anno.dy / 2)
            .attr("x2", anno.x + anno.dx + anno.dx / 2)
            .attr("y2", anno.y + anno.dy / 2)
            .attr("stroke", "#161847")
            .attr("stroke-width", 1.2);
  
            // Add text
            const text = g.append("text")
                .attr("x", function() {
                  if(direction == 1)
                    return anno.x + anno.dx - 30; 
                  return anno.x + anno.dx;
                })
                .attr("y", anno.y + anno.dy)
                .attr("fill", "#495052")
                .attr("font-size", "0.5em")
                .attr("font-family", "Arial")
                .attr("text-anchor", "start");
  
            // Apply text wrapping
            wrapText(text, anno.text, anno.x + anno.dx + anno.dx / 2, anno.y + anno.dy / 2, direction);
        });
      }
    
    
    function updateVisualization(filteredData, nestRegion) {
        var svg1 = d3.select("svg.svg1");

        // remove the annotation
        svg1.selectAll(".annotation").remove();
 
        svg1.selectAll("circle").remove();
 
        var x = d3.scaleLog()
                .range([0, 860])
                .domain([6, 1500]);
 
        var y = d3.scaleLog()
                  .range([400, 0])
                  .domain([90000, 7000000]);
                  
        var gPoints = svg1.append("g")
                        .attr("transform", "translate(60, 50)");
 
        var tooltip = d3.select("#tooltip");
 
        gPoints.selectAll(".circle")
          .data(filteredData)
          .enter().append("circle")
          .attr("class", function(d) {
              let className = "bubbles " + (d.USState ? d.USState.replace(/\s+/g, '-') : "undefined-state");
              // console.log(className);  // add hyphon
              return className;
          })
          .attr("cx", function(d) { return x(d.Area); })
          .attr("cy", function(d) { return y(d.Population2024); })
          .attr("r", function(d) { return 2; })
          .attr("fill", function(d) {
            if(nestRegion == "Pacific States") return "#FF8C00";
            if(nestRegion == "Mountain States") return "#ADFF2F";
            if(nestRegion == "East North Central") return "#F08080";
            if(nestRegion == "West North Central") return "#90EE90";
            if(nestRegion == "Northeast") return "#86F4FF";
            if(nestRegion == "South Atlantic") return "#20B2AA";
            if(nestRegion == "East South Central") return "#B496FF";
            if(nestRegion == "West South Central") return "#23E9A7";
            return checkCity(d.USState);
          })
          .on("click", d => circleClick(d))
          .on('mouseover', function(d,i) {
            tooltip.style("opacity", 0.8)
            .style("left", (d3.event.pageX) + "px")
            .style("top", (d3.event.pageY) + "px")
            .html(d.USCity + '\n' + d.USState + '\n' + d.Density)
          })
          .on('mouseout', function() {
            tooltip.style("opacity", 0)
          })
          .transition().duration(3000).delay(1000)
          .attr("r", function(d) { if(nestRegion == "whole") return Math.pow(d.Density, 1/4.2); return Math.pow(d.Density, 1/3.7); });

          // find new max and min
        let maxRow = filteredData.reduce((max, row) => parseFloat(row.Density) > parseFloat(max.Density) ? row : max, filteredData[0]);
        let minRow = filteredData.reduce((min, row) => parseFloat(row.Density) < parseFloat(min.Density) ? row : min, filteredData[0]);

        let shift = 0;
        let offY = 0;
        if(nestRegion == "East South Central" || nestRegion == "West South Central") shift = 1;
        if(nestRegion == "Mountain States") offY = -40;
        // use filter data to do the annotation
        let newAnnotation = {
          text: "City with highest density:\n" + printAnnotation(maxRow),
          x: x(maxRow.Area),
          y: y(maxRow.Population2024),
          dx: shift == 0 ? 40 : -40,
          dy: -20 + offY,
          direction: shift == 0 ? 'upperRight' : 'upperLeft'
        };

        annotations_svg1 = [];
  
        annotations_svg1.push(newAnnotation);
  
        newAnnotation = {
          text: "City with lowest density:\n" + printAnnotation(minRow),
          x: x(minRow.Area),
          y: y(minRow.Population2024),
          dx: shift == 0 ? -40 : 40,
          dy: -20 + offY,
          direction: shift == 0 ? 'upperLeft' : 'upperRight'
        }
  
        annotations_svg1.push(newAnnotation);
  
        annotations_svg1.forEach(anno => {
            const g = svg1.append("g")
                        .attr("class", "annotation")
                        .attr("transform", "translate(60, 50)");
  
            let direction = 0;
            if(anno.direction == 'upperLeft') direction = 1;
            if(anno.direction == 'lowerRight') direction = 2;
            if(anno.direction == 'lowerLeft') direction = 3;
        
            // Draw the line
            g.append("line")
            .attr("x1", anno.x)
            .attr("y1", anno.y)
            .attr("x2", anno.x + anno.dx / 2)
            .attr("y2", anno.y + anno.dy / 2)
            .attr("stroke", "#161847")
            .attr("stroke-width", 1.2);
  
            // Draw the line
            g.append("line")
            .attr("x1", anno.x + anno.dx / 2)
            .attr("y1", anno.y + anno.dy / 2)
            .attr("x2", anno.x + anno.dx + anno.dx / 2)
            .attr("y2", anno.y + anno.dy / 2)
            .attr("stroke", "#161847")
            .attr("stroke-width", 1.2);
  
            // Add text
            const text = g.append("text")
                .attr("x", function() {
                  if(direction == 1)
                    return anno.x + anno.dx - 30; 
                  return anno.x + anno.dx;
                })
                .attr("y", anno.y + anno.dy)
                .attr("fill", "#495052")
                .attr("font-size", "0.5em")
                .attr("font-family", "Arial")
                .attr("text-anchor", "start");
  
            // Apply text wrapping
            wrapText(text, anno.text, anno.x + anno.dx + anno.dx / 2, anno.y + anno.dy / 2, direction);
        });
        }
            
    function updateVisualization2(filteredData, nestRegion) {
      var svg2 = d3.select("svg.svg2");
      
      svg2.selectAll("rect").remove();
      svg2.selectAll(".gY2").remove();
      svg2.selectAll(".gY2-text").remove();
      
      var tooltip2 = d3.select("#tooltip2");
      
      var x2_positive = d3.scaleLinear()
      .range([0, 430])
      .domain([0, 0.06]);
      
      var x2 = d3.scaleLinear()
      .range([0, 860])
      .domain([-0.06, 0.06]);
      
      var y2 = d3.scaleBand()
      .range([4400, 0])
      .domain(filteredData.map(function(d) {return d.USCity + ", " + d.USState;}))
            .padding(0.1);
            
      var gPoints2 = svg2.append("g")
      .attr("transform", "translate(50, 50)");
      
      gPoints2.selectAll(".rect")
      .data(filteredData)
      .enter().append("rect")
      .attr("x", function(d) { if(parseFloat(d.AnnualChange) < 0) return x2(0) - x2_positive(parseFloat(-d.AnnualChange)); return x2(0);})
      .attr("y", function(d) { return y2(d.USCity + ", " + d.USState); })
      .attr("width", function(d) { return 0; })
      .on("click", d => rectClick(d))
      .on('mouseover', function(d,i) {
        tooltip2.style("opacity", 0.8)
        .style("left", (d3.event.pageX) + "px")
        .style("top", (d3.event.pageY) + "px")
        .html(d.AnnualChange)
      })
      .on('mouseout', function() {
        tooltip2.style("opacity", 0)
      })
      .transition().duration(3000).delay(1000)
      .attr("width", function(d) { if(parseFloat(d.AnnualChange) < 0) return x2_positive(parseFloat(-d.AnnualChange)); return x2_positive(parseFloat(d.AnnualChange)); })
      .attr("height", y2.bandwidth())
      .attr("r", function(d) { return 10; })
      .attr("fill", function(d) {if(!nestRegion.includes(d.USState)) return "#EAEEEC"; if(d.AnnualChange < 0) return "#A51505"; return "#028017";});
      
      var gYAxes2 = svg2.append("g")
      .attr("class", "gY2")
      .attr("transform", "translate(480, 50)")
      .call(d3.axisLeft(y2).tickPadding(10)
      .tickSize(0));
      
      gYAxes2.selectAll(".tick text")
      .attr("class", "gY2-text")
      .attr("x", -450)
      .style("text-anchor", "start");
    }
   
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                              Define helper function                                      //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function printAnnotation(d, svgScene) {
      // if(svgScene == 1) return "City Name: " + d.USCity + "\nState: " + d.USState + "\nThe area of the city is: " + d.Area + "\nThe population in 2020: " + d.Population2020 + "\nThe current population density is: " + d.Density;
      // if(svgScene == 2) return "City Name: " + d.USCity + "\nState: " + d.USState + "\nThe area of the city is: " + d.Area + "\nThe population in 2024: " + d.Population2024 + "\nThe current population density is: " + d.Density;
      if(svgScene == 2) return "City Name: " + d.USCity + "\nState: " + d.USState + "\nThe area of the city is: " + d.Area + "\nThe population in 2020: " + d.Population2020 + "\nThe population in 2024: " + d.Population2024 + "\nDensity change from 2020 to 2024: " + d.AnnualChange;
      return "City Name: " + d.USCity + "\nState: " + d.USState + "\nThe population in 2020: " + d.Population2020 + "\nThe population in 2024: " + d.Population2024 + "\nThe current population density is: " + d.Density;
    }


    function checkCity(cityState) {
      const regions = {
        'Western States': westernStates,
        'Midwestern States': midwesternStates,
        'Eastern States': easternStates,
        'Southern States': southernStates
      };
      let color = '#CFD5A0';
     
      if(regions['Western States'].includes(cityState)) {
        color = '#2222D2';
        return color;
      }
      if(regions['Midwestern States'].includes(cityState)) {
        color = '#1EB50D';
        return color;
      }
      if(regions['Eastern States'].includes(cityState)) {
        color = '#CB1522';
        return color;
      }
      if(regions['Southern States'].includes(cityState)) {
        color = '#FFF347';
        return color;
      }
     
      return color;
    }
   
    function filterByRegion(regionStates) {
      return original_data.filter(d => regionStates.includes(d.USState));
    }
    
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //                                                                                                          //
    //                                              Define button function                                      //
    //                                                                                                          //
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function clearData() {
      clickButton("");
      updateVisualization0(original_data, "whole");
      updateVisualization(original_data, "whole");
      regions_specific= wholeUS;
      updateVisualization2(original_data, regions_specific);
    }
   
    function logRegion(regionName) {
      const regions = {
        'Western States': westernStates,
        'Pacific States': pacificStates,
        'Mountain States': mountainStates,
        'Midwestern States': midwesternStates,
        'East North Central': eastNorthCentral,
        'West North Central': westNorthCentral,
        'Eastern States': easternStates,
        'Northeast': northeast,
        'South Atlantic': southAtlantic,
        'Southern States': southernStates,
        'East South Central': eastSouthCentral,
        'West South Central': westSouthCentral
      };

      clickButton(regions[regionName]);
     
      const filteredData = filterByRegion(regions[regionName]);
      regions_specific = regions[regionName];
      updateVisualization0(filteredData, regionName);
      updateVisualization(filteredData, regionName);
      data = JSON.parse(JSON.stringify(original_data));
      data.sort(function(a,b) {
        return d3.descending(a.USCity, b.USCity);
      });
      updateVisualization2(data, regions_specific);
    }
   
    function sortingChange(sortingMethod, regionName) {
      let data = JSON.parse(JSON.stringify(original_data))
     
      if(sortingMethod == "SortByChangeUp") {
        data.forEach(function(d) {
          d.AnnualChange = parseFloat(d.AnnualChange);
        });
        data.sort(function(a,b) {
          return d3.descending(a.AnnualChange, b.AnnualChange);
        });
      }
      if(sortingMethod == "SortByChangeDown") {
        data.forEach(function(d) {
          d.AnnualChange = parseFloat(d.AnnualChange);
        });
        data.sort(function(a,b) {
          return d3.ascending(a.AnnualChange, b.AnnualChange);
        });
      }
      if(sortingMethod == "SortByAlphabeticUp") {
        data.sort(function(a,b) {
          return d3.descending(a.USCity, b.USCity);
        });
      }
      if(sortingMethod == "SortByAlphabeticDown") {
        data.sort(function(a,b) {
          return d3.ascending(a.USCity, b.USCity);
        });
      }
      updateVisualization2(data, regions_specific);
    }
 
    // delete the resetData() function because ranking according to the dataset is non-sense
    // function resetData() {
    //   updateVisualization2(original_data, regions_specific);
    // }

    function clickButton(stringArray) {
      const container = d3.select(".svg-popup-container");
      const svg = d3.select(".clickShowText");
  
      if (stringArray.length === 0) {
          container.style("display", "none");
      } else {
          container.selectAll("button").remove();
          svg.selectAll("*").remove();

          var myButton = container.append("button")
                                  .style("color", "red")
                                  .style("position", "absolute")
                                  .style("left", "210px")
                                  .style("top", "2px")
                                  .text("X")
                                  .on("click", function() {
                                    svg.selectAll("*").remove();
                                    container.style("display", "none");
                                  });

          var texts = svg.selectAll("text")
                         .data(stringArray, (d) => d);
  
          texts.enter()
                .append("text")
                .attr("x", 5)
                .attr("y", 20)
                .text("The selected groups includes\n");
                        
          texts.enter()
               .append("text")
               .attr("x", 10)
               .attr("y", (d, i) => 20 + 20 * (i + 1))
               .text(d => d)
               .attr("font-size", "0.5em")
               .transition().duration(2000).delay(200)
               .attr("font-size", "1.1em");
  
          // Exit and remove old texts
          texts.exit().remove();
  
          const numItems = stringArray.length;
          const newHeight = numItems * 20 + 30;
          const newWidth = 200;
  
          svg.attr("width", newWidth)
             .attr("height", newHeight);
  
          container.style("display", "block")
                   .style("box-shadow", "2px 2px 5px rgba(0, 0, 0, 0.5)");
        }
    }  

  function circleClick(d) {
    const container = d3.select(".svg-popup-container");
    const svg = d3.select(".clickShowText");

    if(d != undefined) {
        container.selectAll("button").remove();
        svg.selectAll("*").remove();

        var myButton = container.append("button")
                                .style("color", "red")
                                .style("position", "absolute")
                                .style("left", "410px")
                                .style("top", "2px")
                                .text("X")
                                .on("click", function() {
                                  svg.selectAll("*").remove();
                                  container.style("display", "none");
                                });

        let stringArray = printAnnotation(d).split('\n');
        var texts = svg.selectAll("text")
                       .data(stringArray, (d) => d);

        texts.enter()
              .append("text")
              .attr("x", 5)
              .attr("y", 20)
              .text("The information of the selected city is:\n");
                      
        texts.enter()
             .append("text")
             .attr("x", 10)
             .attr("y", (d, i) => 20 + 20 * (i + 1))
             .text(d => d)
             .attr("font-size", "0.5em")
             .transition().duration(2000).delay(200)
             .attr("font-size", "1.1em");

        // Exit and remove old texts
        texts.exit().remove();

        const numItems = stringArray.length;
        const newHeight = numItems * 20 + 30;
        const newWidth = 400;

        svg.attr("width", newWidth)
           .attr("height", newHeight);

        container.style("display", "block")
                 .style("box-shadow", "2px 2px 5px rgba(0, 0, 0, 0.5)");
      }
  }

  function rectClick(d) {
    const container = d3.select(".svg-popup-container");
    const svg = d3.select(".clickShowText");

    if(d != undefined) {
        container.selectAll("button").remove();
        svg.selectAll("*").remove();

        var myButton = container.append("button")
                                .style("color", "red")
                                .style("position", "absolute")
                                .style("left", "410px")
                                .style("top", "2px")
                                .text("X")
                                .on("click", function() {
                                  svg.selectAll("*").remove();
                                  container.style("display", "none");
                                });

        let stringArray = printAnnotation(d, 2).split('\n');
        var texts = svg.selectAll("text")
                       .data(stringArray, (d) => d);

        texts.enter()
              .append("text")
              .attr("x", 5)
              .attr("y", 20)
              .text("The information of the selected city is:\n");
                      
        texts.enter()
             .append("text")
             .attr("x", 10)
             .attr("y", (d, i) => 20 + 20 * (i + 1))
             .text(d => d)
             .attr("font-size", "0.5em")
             .transition().duration(2000).delay(200)
             .attr("font-size", "1.1em");

        // Exit and remove old texts
        texts.exit().remove();

        const numItems = stringArray.length;
        const newHeight = numItems * 20 + 30;
        const newWidth = 400;

        svg.attr("width", newWidth)
           .attr("height", newHeight);

        container.style("display", "block")
                .style("box-shadow", "2px 2px 5px rgba(0, 0, 0, 0.5)");
      }
  }

  function renderSceneOne() {
    const container2 = d3.select(".svg-container2");
    container2.style("display", "none");
    const container = d3.select(".svg-container");
    container.style("display", "none");
    const container0 = d3.select(".svg-container0");
    container0.style("display", "flex");
    
    const resetButton = d3.select(".reset_button");
    resetButton.style("display", "none");
    const sortButtons = d3.select("#sortButton");
    sortButtons.style("display", "none");

    const text1 = d3.select(".scene-one-text");
    text1.style("display", "block");
    const text2 = d3.select(".scene-two-text");
    text2.style("display", "none");
    const text3 = d3.select(".scene-three-text");
    text3.style("display", "none");
  }

  function renderSceneTwo() {
    const container2 = d3.select(".svg-container2");
    container2.style("display", "none");
    const container = d3.select(".svg-container");
    container.style("display", "flex");
    const container0 = d3.select(".svg-container0");
    container0.style("display", "none");

    const resetButton = d3.select(".reset_button");
    resetButton.style("display", "none");
    const sortButtons = d3.select("#sortButton");
    sortButtons.style("display", "none");

    const text1 = d3.select(".scene-one-text");
    text1.style("display", "none");
    const text2 = d3.select(".scene-two-text");
    text2.style("display", "block");
    const text3 = d3.select(".scene-three-text");
    text3.style("display", "none");
  }

  function renderSceneThree() {
    const container2 = d3.select(".svg-container2");
    container2.style("display", "flex");
    const container = d3.select(".svg-container");
    container.style("display", "none");
    const container0 = d3.select(".svg-container0");
    container0.style("display", "none");

    const resetButton = d3.select(".reset_button");
    resetButton.style("display", "flex");
    const sortButtons = d3.select("#sortButton");
    sortButtons.style("display", "flex");

    const text1 = d3.select(".scene-one-text");
    text1.style("display", "none");
    const text2 = d3.select(".scene-two-text");
    text2.style("display", "none");
    const text3 = d3.select(".scene-three-text");
    text3.style("display", "block");
  }
  
</script>
</body>
</html>